{% extends "base.html" %}

{% block title %}Facturar Venta #{{ venta.numero_factura }}{% endblock %}
{% block page_title %}Facturación y Cobro{% endblock %}

{% block content %}
<form method="POST" id="formFacturar">
<div class="row">
    <!-- Columna Principal -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-file-invoice"></i> Facturar Venta: {{ venta.numero_factura }}
            </div>
            <div class="card-body">
                    <!-- Cliente -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Cliente *</strong></label>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p class="mb-1"><strong>{{ venta.cliente.nombre if venta.cliente else 'Cliente Final' }}</strong></p>
                                {% if venta.cliente %}
                                <small class="text-muted">
                                    {% if venta.cliente.numero_documento and venta.cliente.tipo_documento %}
                                        {{ venta.cliente.tipo_documento }}: {{ venta.cliente.numero_documento }}
                                    {% else %}
                                        Doc: N/A
                                    {% endif %}
                                    | Tel: {{ venta.cliente.telefono or 'N/A' }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Ítems -->
                    <h6 class="mb-3">Detalle de Productos/Servicios</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th width="80">Cant.</th>
                                    <th width="120">P. Unit.</th>
                                    <th width="100">Desc.</th>
                                    <th width="120">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detalle in venta.detalles %}
                                <tr>
                                    <td>
                                        <strong>{{ detalle.descripcion }}</strong>
                                        {% if detalle.tipo_item == 'servicio' %}
                                        <br><small class="text-muted">Tipo: {{ detalle.tipo_item|upper }}</small>
                                        {% elif detalle.producto %}
                                        <br><small class="text-muted">Cod: {{ detalle.producto.codigo }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ detalle.cantidad }}</td>
                                    <td class="text-end">Gs. {{ "{:,.0f}".format(detalle.precio_unitario) }}</td>
                                    <td class="text-end">Gs. {{ "{:,.0f}".format(detalle.descuento) }}</td>
                                    <td class="text-end">Gs. {{ "{:,.0f}".format(detalle.total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                                    <td class="text-end">Gs. {{ "{:,.0f}".format(venta.subtotal) }}</td>
                                </tr>
                                {% if venta.descuento > 0 %}
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Descuento:</strong></td>
                                    <td class="text-end text-danger">- Gs. {{ "{:,.0f}".format(venta.descuento) }}</td>
                                </tr>
                                {% endif %}
                                {% if desglose_iva %}
                                    {% if desglose_iva['iva_10']|float > 0 %}
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>IVA 10%:</strong></td>
                                        <td class="text-end">Gs. {{ "{:,.0f}".format(desglose_iva['iva_10']|float) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if desglose_iva['iva_5']|float > 0 %}
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>IVA 5%:</strong></td>
                                        <td class="text-end">Gs. {{ "{:,.0f}".format(desglose_iva['iva_5']|float) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if desglose_iva['exentas']|float > 0 %}
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>Exentas:</strong></td>
                                        <td class="text-end">Gs. {{ "{:,.0f}".format(desglose_iva['exentas']|float) }}</td>
                                    </tr>
                                    {% endif %}
                                {% else %}
                                    {% if venta.iva > 0 %}
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>IVA:</strong></td>
                                        <td class="text-end">Gs. {{ "{:,.0f}".format(venta.iva) }}</td>
                                    </tr>
                                    {% endif %}
                                {% endif %}
                                <tr class="fw-bold">
                                    <td colspan="4" class="text-end"><strong>TOTAL:</strong></td>
                                    <td class="text-end">Gs. {{ "{:,.0f}".format(venta.total) }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
            </div>
        </div>
    </div>

    <!-- Columna Lateral -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <i class="fas fa-info-circle"></i> Resumen de Venta
            </div>
            <div class="card-body">
                <p><strong>Venta Original:</strong> {{ venta.numero_factura }}</p>
                <p><strong>Cliente:</strong> {{ venta.cliente.nombre if venta.cliente else 'Final' }}
                {% if venta.cliente and venta.cliente.numero_documento %}
                <br><small class="text-muted">{{ venta.cliente.tipo_documento }}: {{ venta.cliente.numero_documento }}</small>
                {% endif %}
                </p>
                <p><strong>Estado:</strong> 
                    {% if venta.estado_pago == 'pendiente' %}
                        <span class="badge bg-warning">Pendiente</span>
                    {% elif venta.estado_pago == 'pagado' %}
                        <span class="badge bg-success">Pagado</span>
                    {% else %}
                        <span class="badge bg-info">{{ venta.estado_pago }}</span>
                    {% endif %}
                </p>
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Subtotal:</span>
                    <strong>Gs. {{ "{:,.0f}".format(venta.subtotal) }}</strong>
                </div>
                {% if venta.descuento > 0 %}
                <div class="d-flex justify-content-between">
                    <span>Descuento:</span>
                    <strong>-Gs. {{ "{:,.0f}".format(venta.descuento) }}</strong>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between">
                    <span>IVA:</span>
                    <strong>Gs. {{ "{:,.0f}".format(venta.iva) }}</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>TOTAL:</span>
                    <strong>Gs. {{ "{:,.0f}".format(venta.total) }}</strong>
                </div>
            </div>
        </div>

        <!-- Formas de Pago en la columna lateral -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cash-register"></i> Registrar Pagos (Al Contado)
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-secondary w-100" id="agregar_pago" data-bs-toggle="modal" data-bs-target="#modalPago">
                        <i class="fas fa-plus"></i> Agregar forma de pago
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Forma</th>
                                <th class="text-end">Monto (Gs.)</th>
                                <th>Referencia</th>
                                <th class="text-center" width="60">&nbsp;</th>
                            </tr>
                        </thead>
                        <tbody id="pagos_tbody">
                            <tr class="text-muted" id="fila_vacia">
                                <td colspan="4" class="text-center">Sin pagos agregados</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Resumen -->
                <div class="alert d-none" id="resumen_pagos">
                    <div class="row">
                        <div class="col-6">
                            <strong>Total a Cobrar:</strong><br>
                            Gs. <span id="total_cobrar">{{ "{:,.0f}".format(venta.total) }}</span>
                        </div>
                        <div class="col-6">
                            <strong>Total Pagos:</strong><br>
                            Gs. <span id="total_pagos">0</span>
                        </div>
                        <div class="col-6 mt-2">
                            <strong>Faltante:</strong><br>
                            <span class="text-danger fw-bold">Gs. <span id="total_faltante">{{ "{:,.0f}".format(venta.total) }}</span></span>
                        </div>
                        <div class="col-6 mt-2">
                            <strong>Vuelto:</strong><br>
                            <span class="text-success fw-bold">Gs. <span id="total_vuelto">0</span></span>
                        </div>
                    </div>
                    <div id="alerta_vuelto" class="alert alert-warning mt-2" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i> <span id="mensaje_vuelto"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botones de Acción -->
<div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
    <a href="{{ url_for('ventas.listar') }}" class="btn btn-secondary">
        <i class="fas fa-times"></i> Cancelar
    </a>
    <button type="submit" class="btn btn-success" id="btnFacturar">
        <i class="fas fa-check"></i> Facturar y Cobrar
    </button>
</div>

<!-- Hidden field para pagos -->
<input type="hidden" name="pagos_json" id="pagos_json" value="[]">
</form>

<!-- Modal Agregar Pago -->
<div class="modal fade" id="modalPago" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-money-check-alt"></i> Agregar forma de pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formPagoModal">
                    <div class="mb-3">
                        <label class="form-label">Forma de Pago</label>
                        <select class="form-select" id="modal_forma_pago" required>
                            <option value="">--Seleccionar--</option>
                            {% for fp in formas_pago %}
                            <option value="{{ fp.id }}" data-nombre="{{ fp.nombre }}" data-requiere-ref="{{ fp.requiere_referencia }}">{{ fp.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monto (Gs.)</label>
                        <input type="text" class="form-control" id="modal_monto" inputmode="decimal" placeholder="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Referencia</label>
                        <input type="text" class="form-control" id="modal_referencia" placeholder="Opcional">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="guardar_pago_modal">Guardar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const totalCobrar = parseFloat('{{ venta.total }}');
    const formatter = new Intl.NumberFormat('es-PY');
    let pagos = [];

    function parseMontoInput(valor) {
        if (!valor) return 0;
        // Permite miles con puntos y decimales con coma o punto
        const normalizado = valor.toString().replace(/\./g, '').replace(',', '.');
        return parseFloat(normalizado) || 0;
    }

    function formatearValor(valor) {
        const parsed = parseMontoInput(valor);
        if (!parsed) return '';
        return formatter.format(Math.round(parsed));
    }

    function formatearCampoMonto() {
        const $campo = $('#modal_monto');
        const parsed = parseMontoInput($campo.val());
        if (!parsed) {
            $campo.val('');
            return;
        }
        $campo.val(formatter.format(Math.round(parsed)));
    }

    function formatearMontoEnVivo(event) {
        const input = event.target;
        const caretToEnd = input.selectionEnd === input.value.length;
        const formatted = formatearValor(input.value);
        input.value = formatted;
        if (caretToEnd) {
            input.setSelectionRange(input.value.length, input.value.length);
        }
    }

    function renderPagos() {
        const $tbody = $('#pagos_tbody');
        $tbody.empty();

        if (pagos.length === 0) {
            $tbody.append('<tr class="text-muted" id="fila_vacia"><td colspan="4" class="text-center">Sin pagos agregados</td></tr>');
            return;
        }

        pagos.forEach((pago, idx) => {
            const row = `
                <tr>
                    <td>${pago.forma_nombre}</td>
                    <td class="text-end">${formatter.format(Math.round(pago.monto))}</td>
                    <td>${pago.referencia || ''}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-danger eliminar_pago" data-idx="${idx}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            $tbody.append(row);
        });
    }

    function actualizarTotal() {
        let sumaPagos = pagos.reduce((sum, p) => sum + p.monto, 0);
        let efectivoTotal = {{ efectivo_disponible | default(0) }} + pagos
            .filter(p => (p.forma_nombre || '').toLowerCase().includes('efectivo'))
            .reduce((s, p) => s + p.monto, 0);

        const $resumen = $('#resumen_pagos');
        const $alertaVuelto = $('#alerta_vuelto');

        if (sumaPagos <= 0) {
            $resumen.addClass('d-none').removeClass('alert-success alert-warning alert-danger');
            $('#btnFacturar').prop('disabled', true);
            $('#total_pagos').text('0');
            $('#total_faltante').text(formatter.format(Math.round(totalCobrar)));
            $('#total_vuelto').text('0');
            $alertaVuelto.hide();
            return;
        }

        $resumen.removeClass('d-none');
        $('#total_pagos').text(formatter.format(Math.round(sumaPagos)));

        const diferencia = sumaPagos - totalCobrar;
        const faltante = Math.max(0, -diferencia);
        const vuelto = Math.max(0, diferencia);

        $('#total_faltante').text(formatter.format(Math.round(faltante)));
        $('#total_vuelto').text(formatter.format(Math.round(vuelto)));

        if (sumaPagos >= totalCobrar) {
            $resumen.removeClass('alert-warning alert-danger').addClass('alert-success');
            $('#btnFacturar').prop('disabled', false);

            if (vuelto > 0) {
                if (efectivoTotal < vuelto) {
                    const faltaEfectivo = vuelto - efectivoTotal;
                    $('#mensaje_vuelto').html(
                        `<strong>Advertencia:</strong> El vuelto es ${formatter.format(Math.round(vuelto))} Gs. pero solo hay ${formatter.format(Math.round(efectivoTotal))} Gs. en efectivo. Faltan ${formatter.format(Math.round(faltaEfectivo))} Gs. para cubrir el vuelto.`
                    );
                    $alertaVuelto.removeClass('alert-info').addClass('alert-warning').show();
                } else {
                    $('#mensaje_vuelto').html(
                        `<i class="fas fa-info-circle"></i> Se devolverá ${formatter.format(Math.round(vuelto))} Gs. en efectivo al cliente.`
                    );
                    $alertaVuelto.removeClass('alert-warning').addClass('alert-info').show();
                }
            } else {
                $alertaVuelto.hide();
            }
        } else {
            $resumen.removeClass('alert-success alert-danger').addClass('alert-warning');
            $('#btnFacturar').prop('disabled', true);
            $alertaVuelto.hide();
        }
    }

    // Modal: reset al abrir
    $('#modalPago').on('shown.bs.modal', function() {
        $('#formPagoModal')[0].reset();
        $('#modal_forma_pago').focus();
    });

    // Formatear monto al perder foco o cambiar
    $(document).on('blur change', '#modal_monto', formatearCampoMonto);
    $(document).on('keyup', '#modal_monto', function(e) {
        if (e.key === 'Enter') {
            formatearCampoMonto();
        }
    });
    $(document).on('input', '#modal_monto', formatearMontoEnVivo);

    // Guardar pago desde modal
    $('#guardar_pago_modal').on('click', function() {
        const formaId = $('#modal_forma_pago').val();
        const formaNombre = $('#modal_forma_pago option:selected').data('nombre');
        const monto = parseMontoInput($('#modal_monto').val());
        const referencia = $('#modal_referencia').val();

        if (!formaId) {
            alert('Seleccione una forma de pago');
            return;
        }
        if (monto <= 0) {
            alert('Ingrese un monto mayor a 0');
            return;
        }

        // Reflejar formato en el input tras parsear
        $('#modal_monto').val(formatter.format(Math.round(monto)));

        pagos.push({
            forma_pago_id: formaId,
            forma_nombre: formaNombre,
            monto: monto,
            referencia: referencia || ''
        });

        renderPagos();
        actualizarTotal();
        $('#modalPago').modal('hide');
    });

    // Eliminar pago desde grilla
    $(document).on('click', '.eliminar_pago', function() {
        const idx = $(this).data('idx');
        pagos.splice(idx, 1);
        renderPagos();
        actualizarTotal();
    });

    // Inicializar
    renderPagos();
    actualizarTotal();

    // Enviar formulario
    $('#formFacturar').submit(function(e) {
        e.preventDefault();

        if (pagos.length === 0) {
            alert('Agregue al menos un pago');
            return false;
        }

        const sumaPagos = pagos.reduce((sum, p) => sum + p.monto, 0);
        if (sumaPagos < totalCobrar) {
            alert(`El total de pagos (${formatter.format(Math.round(sumaPagos))}) es menor al total (${formatter.format(Math.round(totalCobrar))}). Complete el monto faltante.`);
            return false;
        }

        $('#pagos_json').val(JSON.stringify(pagos));
        this.submit();
    });
});
</script>
{% endblock %}
