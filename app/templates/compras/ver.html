{% extends "base.html" %}

{% block title %}Ver Compra{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <!-- ENCABEZADO -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3">
                    <i class="fas fa-file-invoice"></i> Compra {{ compra.numero_compra }}
                </h1>
                <div>
                    <a href="{{ url_for('compras.pendientes_pago') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                    {# Mostrar botón Pagar solo si NO es a crédito (sin cuenta por pagar pendiente/parcial) #}
                    {% if not cuenta or cuenta.estado == 'pagada' %}
                        {% if compra.estado == 'registrada' %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPagar">
                            <i class="fas fa-money-bill-wave"></i> Pagar
                        </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- INFORMACIÓN GENERAL -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Información General</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th width="40%">Número de Compra:</th>
                                <td><strong>{{ compra.numero_compra }}</strong></td>
                            </tr>
                            {% if compra.numero_factura %}
                            <tr>
                                <th>Nro. Factura proveedor:</th>
                                <td>{{ compra.numero_factura }}</td>
                            </tr>
                            {% endif %}
                            {% if compra.fecha_factura %}
                            <tr>
                                <th>Fecha factura:</th>
                                <td>{{ compra.fecha_factura.strftime('%d/%m/%Y') }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <th>Proveedor:</th>
                                <td>{{ compra.proveedor.razon_social }}</td>
                            </tr>
                            <tr>
                                <th>Tipo:</th>
                                <td>
                                    <span class="badge" style="background-color: {% if compra.tipo == 'producto' %}#007bff{% elif compra.tipo == 'servicio' %}#28a745{% elif compra.tipo == 'factura' %}#fd7e14{% else %}#6c757d{% endif %};">
                                        {{ compra.tipo | upper }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>Fecha Compra:</th>
                                <td>{{ compra.fecha_compra.strftime('%d/%m/%Y %H:%M') }}</td>
                            </tr>
                            <tr>
                                <th>Registrado por:</th>
                                <td>{{ compra.usuario_registra.nombre if compra.usuario_registra else 'N/A' }}</td>
                            </tr>
                            <tr>
                                <th>Estado:</th>
                                <td>
                                    {% if compra.estado == 'registrada' %}
                                        <span class="badge bg-warning">No Pagado</span>
                                    {% elif compra.estado == 'parcial_pagada' %}
                                        <span class="badge bg-info">Pago Parcial</span>
                                    {% elif compra.estado == 'pagada' %}
                                        <span class="badge bg-success">Pagado</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    {% if compra.descripcion %}
                    <div class="mt-3">
                        <strong>Descripción:</strong>
                        <p class="text-muted">{{ compra.descripcion }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- TOTALES -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator"></i> Totales</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th width="40%">Subtotal:</th>
                                <td class="text-end">Gs. {{ "{:,.0f}".format(compra.subtotal or 0) }}</td>
                            </tr>
                            <tr>
                                <th>IVA (10%):</th>
                                <td class="text-end">Gs. {{ "{:,.0f}".format(compra.iva or 0) }}</td>
                            </tr>
                            <tr class="table-active">
                                <th><strong>TOTAL:</strong></th>
                                <td class="text-end"><strong>Gs. {{ "{:,.0f}".format(compra.total or 0) }}</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    {% if compra.stock_actualizado %}
                    <div class="alert alert-success mt-3 mb-0">
                        <i class="fas fa-check-circle"></i> Stock actualizado
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- DETALLES DE LA COMPRA -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-list"></i> Detalles de la Compra</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            {% if compra.tipo == 'producto' %}
                            <th>Código</th>
                            <th>Producto</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-end">Precio Unitario</th>
                            <th class="text-end">Subtotal</th>
                            {% else %}
                            <th>Concepto/Descripción</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-end">Precio</th>
                            <th class="text-end">Subtotal</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for detalle in compra.detalles %}
                        <tr>
                            {% if compra.tipo == 'producto' and detalle.producto %}
                            <td>{{ detalle.producto.codigo }}</td>
                            <td>{{ detalle.producto.nombre }}</td>
                            <td class="text-center">{{ "{:.0f}".format(detalle.cantidad) }}</td>
                            <td class="text-end">Gs. {{ "{:,.0f}".format(detalle.precio_unitario) }}</td>
                            <td class="text-end">Gs. {{ "{:,.0f}".format(detalle.subtotal) }}</td>
                            {% else %}
                            <td>{{ detalle.concepto }}</td>
                            <td class="text-center">{{ detalle.cantidad }}</td>
                            <td class="text-end">Gs. {{ "{:,.0f}".format(detalle.precio_unitario) }}</td>
                            <td class="text-end">Gs. {{ "{:,.0f}".format(detalle.subtotal) }}</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- HISTORIAL DE PAGOS DE PROVEEDOR (CUENTA POR PAGAR) -->
    {% if cuenta %}
    <div class="card mb-4">
        <div class="card-header bg-warning">
            <h5 class="mb-0"><i class="fas fa-history"></i> Historial de Pagos a Proveedor</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="alert alert-success mb-2 py-2">
                        <strong>Total abonado:</strong><br>
                        <span class="fs-5">Gs. {{ "{:,.0f}".format(total_abonado) }}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-danger mb-2 py-2">
                        <strong>Saldo pendiente:</strong><br>
                        <span class="fs-5">Gs. {{ "{:,.0f}".format(saldo_pendiente) }}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-info mb-2 py-2">
                        <strong>Estado de la cuenta:</strong><br>
                        {% if cuenta.estado == 'pagada' %}
                            <span class="badge bg-success">Pagada</span>
                        {% elif cuenta.estado == 'parcial' %}
                            <span class="badge bg-info">Pago Parcial</span>
                        {% else %}
                            <span class="badge bg-warning">Pendiente</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha</th>
                            <th>Monto</th>
                            <th>Forma de Pago</th>
                            <th>Referencia</th>
                            <th>Registrado por</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in pagos_proveedor %}
                        <tr>
                            <td>{{ pago.fecha_pago.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>Gs. {{ "{:,.0f}".format(pago.monto) }}</td>
                            <td>{{ pago.forma_pago|capitalize }}</td>
                            <td>{{ pago.referencia or '-' }}</td>
                            <td>{{ pago.usuario_registra.nombre if pago.usuario_registra else 'N/A' }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-center text-muted">Sin pagos registrados</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- MODAL PAGAR (igual al de pendientes_pago.html) -->
<div class="modal fade" id="modalPagar" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-credit-card"></i> Registrar Pago de Compra</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form method="POST" action="{{ url_for('compras.pagar_compra', id=compra.id) }}">
                <div class="modal-body">
                    <div class="alert alert-light border mb-3">
                        <small>
                            <strong>Compra:</strong> {{ compra.numero_compra }}<br>
                            <strong>Total Compra:</strong> Gs. {{ "{:,.0f}".format(compra.total) }}
                        </small>
                    </div>

                    <!-- MONTO A PAGAR -->
                    <div class="mb-3">
                        <label for="monto" class="form-label required">Monto a Pagar</label>
                        <div class="input-group">
                            <span class="input-group-text">Gs.</span>
                            <input type="number" class="form-control" id="monto" name="monto" 
                                   value="{{ "{:.0f}".format(compra.total) }}" min="0" step="1" required>
                        </div>
                    </div>

                    <!-- ORIGEN DEL PAGO -->
                    <div class="mb-4">
                        <label class="form-label required">Origen del Pago</label>
                        
                        <div class="form-check mb-3 border-start border-primary ps-3">
                            <input class="form-check-input" type="radio" name="origen_pago" 
                                   id="origen_caja" value="caja_chica" checked>
                            <label class="form-check-label" for="origen_caja">
                                <strong><i class="fas fa-cash-register"></i> Caja Chica (Descuenta de Apertura)</strong>
                            </label>
                        </div>

                        <div class="form-check mb-3 border-start border-warning ps-3">
                            <input class="form-check-input" type="radio" name="origen_pago" 
                                   id="origen_otra" value="otra_fuente">
                            <label class="form-check-label" for="origen_otra">
                                <strong><i class="fas fa-external-link-alt"></i> Otra Fuente (No afecta Caja)</strong>
                            </label>
                        </div>

                        <div class="form-check border-start border-danger ps-3">
                            <input class="form-check-input" type="radio" name="origen_pago" 
                                   id="origen_credito" value="dejar_credito">
                            <label class="form-check-label" for="origen_credito">
                                <strong><i class="fas fa-handshake"></i> Dejar a Crédito</strong>
                            </label>
                        </div>
                    </div>

                    <!-- CAMPOS DE CRÉDITO -->
                    <div id="grupo_credito" class="mb-3" style="display: none;">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label">Plazo de crédito (días)</label>
                                <select class="form-select" name="plazo_credito_dias" id="plazo_credito_dias">
                                    <option value="0">Seleccionar...</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                    <option value="60">60</option>
                                    <option value="90">90</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fecha de vencimiento</label>
                                <input type="date" class="form-control" name="fecha_vencimiento_credito" id="fecha_vencimiento_credito" readonly>
                            </div>
                            <div class="col-md-12 mt-2">
                                <label class="form-label">Observaciones de crédito</label>
                                <textarea class="form-control" name="observaciones_credito" rows="2" placeholder="Acordado en 3 pagos, etc."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="referencia" class="form-label">Referencia</label>
                        <input type="text" class="form-control" id="referencia" name="referencia">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Confirmar Pago
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Mostrar/ocultar campos de crédito y controlar monto
function toggleCreditoFields() {
    const origenCredito = document.getElementById('origen_credito').checked;
    const grupo = document.getElementById('grupo_credito');
    const monto = document.getElementById('monto');
    if (origenCredito) {
        grupo.style.display = '';
        monto.value = 0;
        monto.setAttribute('readonly', 'readonly');
    } else {
        grupo.style.display = 'none';
        monto.removeAttribute('readonly');
        if (!monto.value || parseInt(monto.value) === 0) {
            monto.value = {{ "{:.0f}".format(compra.total) }};
        }
    }
}
['origen_caja','origen_otra','origen_credito'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', toggleCreditoFields);
});
toggleCreditoFields();

// Calcular fecha de vencimiento desde plazo
document.getElementById('plazo_credito_dias').addEventListener('change', function() {
    const dias = parseInt(this.value || '0');
    const inputFecha = document.getElementById('fecha_vencimiento_credito');
    if (!dias) { inputFecha.value=''; return; }
    const hoy = new Date();
    hoy.setDate(hoy.getDate() + dias);
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth()+1).padStart(2,'0');
    const dd = String(hoy.getDate()).padStart(2,'0');
    inputFecha.value = `${yyyy}-${mm}-${dd}`;
});
</script>
{% endblock %}
