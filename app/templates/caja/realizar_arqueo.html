{% extends "base.html" %}

{% block title %}Realizar Arqueo{% endblock %}
{% block page_title %}Cierre y Arqueo de Caja{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <a href="{{ url_for('caja.estado') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Cancelar
        </a>
    </div>
</div>

<div class="row">
    <!-- SECCIÓN 1: SISTEMA (LO ESPERADO) -->
    <div class="col-md-5">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-laptop"></i> SISTEMA
                </h5>
                <small>Lo que debería haber en caja según registros</small>
            </div>
            <div class="card-body">
                <p><strong>Caja:</strong> {{ apertura.caja.nombre }}</p>
                <p><strong>Cajero:</strong> {{ apertura.cajero.username }}</p>
                <hr>
                
                <h6 class="mb-3"><strong>Monto Inicial:</strong></h6>
                <p class="text-center h5 text-success mb-4">
                    Gs. {{ "{:,.0f}".format(apertura.monto_inicial) }}
                </p>

                <h6 class="mb-3"><strong>Total Ventas por Forma de Pago:</strong></h6>
                <table class="table table-sm table-borderless">
                    <tr>
                        <td><i class="fas fa-money-bill-wave text-success"></i> Efectivo</td>
                        <td class="text-end"><strong class="text-success">Gs. {{ "{:,.0f}".format(totales_sistema.efectivo) }}</strong></td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-credit-card text-info"></i> Tarjeta Crédito/Débito</td>
                        <td class="text-end"><strong class="text-info">Gs. {{ "{:,.0f}".format(totales_sistema.tarjeta) }}</strong></td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-exchange-alt text-secondary"></i> Transferencias</td>
                        <td class="text-end"><strong class="text-secondary">Gs. {{ "{:,.0f}".format(totales_sistema.transferencia) }}</strong></td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-file-alt text-warning"></i> Cheques</td>
                        <td class="text-end"><strong class="text-warning">Gs. {{ "{:,.0f}".format(totales_sistema.cheque) }}</strong></td>
                    </tr>
                </table>

                <div class="alert alert-primary mt-4 mb-0">
                    <h6 class="mb-2"><strong>TOTAL ESPERADO EN CAJA:</strong></h6>
                    <h4 class="mb-0 text-center">Gs. {{ "{:,.0f}".format(totales_sistema.total) }}</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 2: ARQUEO (LO REAL) -->
    <div class="col-md-7">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-list-check"></i> ARQUEO
                </h5>
                <small>Ingrese lo que hay realmente en caja (conteo físico)</small>
            </div>
            <div class="card-body">
                <form method="POST" id="arqueoForm">
                    <div class="alert alert-light border-info mb-4">
                        <i class="fas fa-info-circle"></i> <strong>Instrucciones:</strong>
                        <ul class="mb-0 mt-2 small">
                            <li><strong>Efectivo:</strong> Contar el dinero físico en caja</li>
                            <li><strong>Tarjeta Crédito/Débito:</strong> Verificar comprobantes (solo referencia)</li>
                            <li><strong>Transferencias:</strong> Verificar banco (solo referencia)</li>
                            <li><strong>Cheques:</strong> Contar cheques en caja (solo referencia)</li>
                        </ul>
                    </div>

                    <!-- EFECTIVO -->
                    <div class="mb-4">
                        <label for="monto_efectivo_real" class="form-label">
                            <i class="fas fa-money-bill-wave text-success"></i> <strong>Total en Efectivo *</strong>
                        </label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">Gs.</span>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="monto_efectivo_real" 
                                name="monto_efectivo_real" 
                                min="0" 
                                step="1"
                                required
                                oninput="calcularDiferencias()"
                            >
                        </div>
                        <small class="text-muted d-block mt-2">
                            Esperado: <strong class="text-success">Gs. {{ "{:,.0f}".format(totales_sistema.efectivo) }}</strong>
                        </small>
                    </div>

                    <!-- TARJETAS -->
                    <div class="mb-4">
                        <label for="monto_tarjeta_real" class="form-label">
                            <i class="fas fa-credit-card text-info"></i> <strong>Total en Tarjeta Crédito y Débito</strong>
                        </label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">Gs.</span>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="monto_tarjeta_real" 
                                name="monto_tarjeta_real" 
                                min="0" 
                                step="1"
                                oninput="calcularDiferencias()"
                            >
                        </div>
                        <small class="text-muted d-block mt-2">
                            Esperado: <strong class="text-info">Gs. {{ "{:,.0f}".format(totales_sistema.tarjeta) }}</strong>
                        </small>
                    </div>

                    <!-- TRANSFERENCIAS -->
                    <div class="mb-4">
                        <label for="monto_transferencias_real" class="form-label">
                            <i class="fas fa-exchange-alt text-secondary"></i> <strong>Total en Transferencias</strong>
                        </label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">Gs.</span>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="monto_transferencias_real" 
                                name="monto_transferencias_real" 
                                min="0" 
                                step="1"
                                oninput="calcularDiferencias()"
                            >
                        </div>
                        <small class="text-muted d-block mt-2">
                            Esperado: <strong class="text-secondary">Gs. {{ "{:,.0f}".format(totales_sistema.transferencia) }}</strong>
                        </small>
                    </div>

                    <!-- CHEQUES -->
                    <div class="mb-4">
                        <label for="monto_cheques_real" class="form-label">
                            <i class="fas fa-file-alt text-warning"></i> <strong>Total en Cheques</strong>
                        </label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">Gs.</span>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="monto_cheques_real" 
                                name="monto_cheques_real" 
                                min="0" 
                                step="1"
                                oninput="calcularDiferencias()"
                            >
                        </div>
                        <small class="text-muted d-block mt-2">
                            Esperado: <strong class="text-warning">Gs. {{ "{:,.0f}".format(totales_sistema.cheque) }}</strong>
                        </small>
                    </div>

                    <!-- RESUMEN -->
                    <div class="card bg-light border-primary mt-4 mb-4">
                        <div class="card-body">
                            <h6 class="mb-3"><strong>RESUMEN DE ARQUEO</strong></h6>
                            <table class="table table-sm table-borderless mb-0">
                                <tr>
                                    <td><strong>Total Sistema:</strong></td>
                                    <td class="text-end">Gs. <span id="sist_total">{{ "{:,.0f}".format(totales_sistema.total) }}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Total Real:</strong></td>
                                    <td class="text-end">Gs. <span id="real_total">0</span></td>
                                </tr>
                                <tr class="border-top">
                                    <td><strong>Diferencia:</strong></td>
                                    <td class="text-end" id="diferencia_total"><span class="badge bg-secondary">Gs. 0</span></td>
                                </tr>
                            </table>
                            <div class="alert mt-3 mb-0" id="alertaDiferencia"></div>
                        </div>
                    </div>

                    <!-- OBSERVACIONES -->
                    <div class="mb-4">
                        <label for="observaciones" class="form-label">
                            <i class="fas fa-sticky-note"></i> Observaciones (Opcional)
                        </label>
                        <textarea 
                            class="form-control" 
                            id="observaciones" 
                            name="observaciones" 
                            rows="2"
                            placeholder="Ej: Cheques pendientes de depositar, etc."
                        ></textarea>
                    </div>

                    <!-- BOTÓN -->
                    <button type="submit" class="btn btn-success btn-lg w-100">
                        <i class="fas fa-check-circle"></i> Guardar Arqueo y Cerrar Caja
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const valoresEsperados = {
        efectivo: {{ totales_sistema.efectivo }},
        tarjeta: {{ totales_sistema.tarjeta }},
        transferencias: {{ totales_sistema.transferencia }},
        cheques: {{ totales_sistema.cheque }},
        total: {{ totales_sistema.total }}
    };

    function formatearMoneda(valor) {
        return Math.round(valor || 0).toLocaleString('es-PY', { 
            minimumFractionDigits: 0, 
            maximumFractionDigits: 0 
        });
    }

    function calcularDiferencias() {
        const efectivoReal = parseFloat(document.getElementById('monto_efectivo_real').value) || 0;
        const tarjetaReal = parseFloat(document.getElementById('monto_tarjeta_real').value) || 0;
        const transferenciaReal = parseFloat(document.getElementById('monto_transferencias_real').value) || 0;
        const chequeReal = parseFloat(document.getElementById('monto_cheques_real').value) || 0;

        const totalReal = efectivoReal + tarjetaReal + transferenciaReal + chequeReal;
        const diferencia = totalReal - valoresEsperados.total;

        // Actualizar resumen
        document.getElementById('real_total').textContent = formatearMoneda(totalReal);
        document.getElementById('diferencia_total').innerHTML = mostrarDiferencia(diferencia);

        // Alerta
        const alertaDiv = document.getElementById('alertaDiferencia');
        alertaDiv.className = 'alert mb-0';
        
        if (Math.abs(diferencia) < 0.01) {
            alertaDiv.className += ' alert-success';
            alertaDiv.innerHTML = '<i class="fas fa-check-circle"></i> <strong>¡ARQUEO CUADRADO!</strong> Todos los valores coinciden.';
        } else if (Math.abs(diferencia) <= 1000) {
            alertaDiv.className += ' alert-warning';
            alertaDiv.innerHTML = `<i class="fas fa-exclamation"></i> Diferencia menor: ${diferencia >= 0 ? '+' : ''}Gs. ${formatearMoneda(Math.abs(diferencia))}`;
        } else if (diferencia > 0) {
            alertaDiv.className += ' alert-info';
            alertaDiv.innerHTML = `<i class="fas fa-plus-circle"></i> Sobrante en caja: +Gs. ${formatearMoneda(diferencia)}`;
        } else {
            alertaDiv.className += ' alert-danger';
            alertaDiv.innerHTML = `<i class="fas fa-minus-circle"></i> Faltante en caja: Gs. ${formatearMoneda(Math.abs(diferencia))}`;
        }
    }

    function mostrarDiferencia(valor) {
        const formatted = formatearMoneda(Math.abs(valor));
        if (Math.abs(valor) < 0.01) {
            return '<span class="badge bg-success">Cuadrado</span>';
        } else if (valor > 0) {
            return `<span class="badge bg-info">+Gs. ${formatted}</span>`;
        } else {
            return `<span class="badge bg-danger">-Gs. ${formatted}</span>`;
        }
    }

    // Ejecutar al cargar
    document.addEventListener('DOMContentLoaded', calcularDiferencias);
</script>
{% endblock %}
