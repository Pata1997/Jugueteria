{% extends 'base.html' %}
{% block title %}Detalle de Reclamo{% endblock %}
{% block page_title %}Detalle de Reclamo{% endblock %}
{% block content %}
<div class="container mt-4">
    <h3 class="mb-4">Detalle de Reclamo</h3>
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Reclamo #{{ reclamo.numero }}</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Cliente:</strong> {{ reclamo.cliente.nombre if reclamo.cliente else '-' }}</p>
                    <p><strong>Documento:</strong>
                        {% if reclamo.documento_tipo == 'factura' %}
                            Factura {{ reclamo.documento_numero }}
                        {% elif reclamo.documento_tipo == 'servicio' %}
                            Servicio {{ reclamo.documento_numero }}
                        {% else %}
                            {{ reclamo.documento_numero or '-' }}
                        {% endif %}
                    </p>
                    <p><strong>Tipo de Reclamo:</strong> {{ reclamo.tipo_reclamo }}</p>
                    <p><strong>Prioridad:</strong> {{ reclamo.prioridad|capitalize }}</p>
                    <p><strong>Estado:</strong> {{ reclamo.estado|capitalize }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Responsable:</strong> {{ reclamo.responsable.nombre_completo if reclamo.responsable else '-' }}</p>
                    <p><strong>Fecha creación:</strong> {{ reclamo.fecha_creacion.strftime('%d/%m/%Y') }}</p>
                    <p><strong>Fecha estimada resolución:</strong> {{ reclamo.fecha_estimada_resolucion.strftime('%d/%m/%Y') if reclamo.fecha_estimada_resolucion else '-' }}</p>
                    <p><strong>Fecha cierre:</strong> {{ reclamo.fecha_cierre.strftime('%d/%m/%Y') if reclamo.fecha_cierre else '-' }}</p>
                </div>
            </div>
            <p><strong>Descripción:</strong> {{ reclamo.descripcion }}</p>
            <p><strong>Resolución:</strong> {{ reclamo.resolucion or '-' }}</p>
        </div>
    </div>
    <h5 class="mt-4">Historial de Cambios</h5>
    <div class="table-responsive mb-3">
        <table class="table table-bordered table-sm">
            <thead class="table-light">
                <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Estado Anterior</th>
                    <th>Estado Nuevo</th>
                    <th>Comentario</th>
                </tr>
            </thead>
            <tbody>
                {% for h in reclamo.historial.order_by(reclamo.historial.model.fecha.desc()).all() %}
                <tr>
                    <td>{{ h.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>{{ h.usuario.nombre_completo if h.usuario else '-' }}</td>
                    <td>{{ h.estado_anterior or '-' }}</td>
                    <td>{{ h.estado_nuevo|capitalize }}</td>
                    <td>{{ h.comentario }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="d-flex gap-2 mt-3">
                <a href="{{ url_for('reclamos.listar') }}" class="btn btn-secondary">Volver</a>
                {% if reclamo.estado != 'cerrado' %}
                        <button class="btn btn-warning" onclick="abrirModalEstado({{ reclamo.id }})">Cambiar Estado</button>
                        <button class="btn btn-danger" onclick="abrirModalCerrar({{ reclamo.id }})">Cerrar Reclamo</button>
                {% endif %}
        </div>

        <!-- Modal Cambiar Estado -->
        <div class="modal fade" id="modalEstado" tabindex="-1" aria-labelledby="modalEstadoLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="formCambiarEstado" method="POST" action="{{ url_for('reclamos.cambiar_estado', id=reclamo.id) }}">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalEstadoLabel">Cambiar Estado</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="estado_nuevo_modal">Estado</label>
                                <select class="form-select" id="estado_nuevo_modal" name="estado_nuevo" required>
                                    <option value="en_analisis">En análisis</option>
                                    <option value="en_proceso">En proceso</option>
                                    <option value="pendiente_cliente">Pendiente cliente</option>
                                    <option value="resuelto">Resuelto</option>
                                    <option value="cerrado">Cerrado</option>
                                    <option value="rechazado">Rechazado</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="comentario_modal">Comentario</label>
                                <input type="text" class="form-control" id="comentario_modal" name="comentario">
                            </div>
                            <div class="mb-3">
                                <label for="resolucion_modal">Resolución (requerido para cerrar o resolver)</label>
                                <textarea class="form-control" id="resolucion_modal" name="resolucion" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Cerrar Reclamo -->
        <div class="modal fade" id="modalCerrar" tabindex="-1" aria-labelledby="modalCerrarLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="formCerrarReclamo" method="POST" action="{{ url_for('reclamos.cambiar_estado', id=reclamo.id) }}">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalCerrarLabel">Cerrar Reclamo</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="resolucion_cerrar">Resolución <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="resolucion_cerrar" name="resolucion" rows="2" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="comentario_cerrar">Comentario final</label>
                                <input type="text" class="form-control" id="comentario_cerrar" name="comentario">
                            </div>
                            <input type="hidden" name="estado_nuevo" value="cerrado">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-danger">Cerrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% block extra_js %}
        <script>
            function abrirModalEstado(id) {
                var modal = new bootstrap.Modal(document.getElementById('modalEstado'));
                modal.show();
            }
            function abrirModalCerrar(id) {
                var modal = new bootstrap.Modal(document.getElementById('modalCerrar'));
                modal.show();
            }
        </script>
        {% endblock %}
</div>
{% endblock %}
